Attribute VB_Name = "Module1"
Sub CopyAndPopulateSheet(templateSheetName As String, newSheetName As String, dataCollection As Collection)
    Dim sourceSheet As Worksheet, targetSheet As Worksheet
    Dim lastRow As Long
    Dim i As Integer
    Dim record As Variant

    ' Ensure template exists
    Set sourceSheet = ThisWorkbook.Sheets(templateSheetName)
    sourceSheet.Copy After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count)
    Set targetSheet = ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count)
    targetSheet.Name = newSheetName

    ' Write data to the new sheet
    lastRow = 2 ' Assuming headers are in the first row
    For Each record In dataCollection
        With targetSheet
            .Cells(lastRow, "B").Value = record.ID
            .Cells(lastRow, "C").Value = record.Temperature
            .Cells(lastRow, "D").Value = record.Location
            .Cells(lastRow, "E").Value = record.DateValue
            .Cells(lastRow, "F").Value = record.TemperatureValue
            .Cells(lastRow, "G").Value = record.Force
        End With
        lastRow = lastRow + 1
    Next record
End Sub


'譁ｰ縺励＞繧ｳ繝ｼ繝峨↓縺ｯ蜷ｫ縺ｾ繧後※縺�縺ｪ縺�縲�
Function GenerateSheetName(prefix As String, index As Integer) As String
    GenerateSheetName = prefix & Format(index, "00")
End Function




' Main繝励Ο繧ｷ繝ｼ繧ｸ繝｣
Sub TestSheetCreationAndDataWriting()
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets("DataSheet")
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).row
    Dim i As Integer

    Dim testValues As New Collection
    Dim groupedRecords As Object
    Set groupedRecords = CreateObject("Scripting.Dictionary")

    For i = 2 To lastRow
        Dim Record As New Record
        Record.LoadData ws, i
        testValues.Add Record

        ' 分類されたグループにレコードを追加
        If Not groupedRecords.Exists(Record.Group) Then
            groupedRecords.Add Record.Group, New Collection
        End If
        groupedRecords(Record.Group).Add Record
    Next i

    ' 繧ｰ繝ｫ繝ｼ繝励�ｮ蜀�螳ｹ繧堤｢ｺ隱搾ｼ医ョ繝舌ャ繧ｰ逕ｨ�ｼ�
    Dim key As Variant
    For Each key In groupedRecords
        Debug.Print "Group: " & key & ", Count: " & groupedRecords(key).Count
    Next key

    ' 繝�繝ｼ繧ｿ縺ｮ繧ｰ繝ｫ繝ｼ繝怜喧縺ｨ繧ｷ繝ｼ繝域嶌縺崎ｾｼ縺ｿ繧定｡後≧
    Call PopulateGroupedSheets
End Sub

Sub PopulateGroupedSheets(groupedRecords As Object)
    Dim ws As Worksheet
    Dim sheetIndex As Integer
    Dim key As Variant
    Dim newSheetName As String
    Dim templateName As String

    sheetIndex = 1

    For Each key In groupedRecords.Keys
        ' Template sheet determination based on group key
        If InStr(key, "SingleValue") > 0 Then
            templateName = "Temp_Shinsei"
        ElseIf InStr(key, "OtherValue") > 0 Then
            templateName = "Temp_Teiki"
        Else
            templateName = "Temp_Irai"
        End If

        ' Generate unique sheet name
        newSheetName = key & "_" & sheetIndex

        ' Check if the sheet already exists
        If Not SheetExists(newSheetName) Then
            ' Copy and populate the sheet if it does not exist
            Call CopyAndPopulateSheet(templateName, newSheetName, groupedRecords(key))
            sheetIndex = sheetIndex + 1  ' Increment sheet index only if a new sheet was created
        Else
            ' Optionally, you can handle the case where the sheet already exists
            Debug.Print "Sheet already exists: " & newSheetName
        End If
    Next key
End Sub

Function SheetExists(sheetName As String) As Boolean
    Dim tmpSheet As Worksheet
    On Error Resume Next
    Set tmpSheet = ThisWorkbook.Sheets(sheetName)
    SheetExists = Not tmpSheet Is Nothing
    On Error GoTo 0
End Function
